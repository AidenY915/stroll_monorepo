"""
Stroll í¬ë¡¤ë§ ë° ì£¼ì†Œ ë³€í™˜ DAG
Naver ì§€ë„ì—ì„œ ì¥ì†Œ ë°ì´í„°ë¥¼ í¬ë¡¤ë§í•˜ê³ , ê° ì¥ì†Œë³„ë¡œ ì£¼ì†Œë¥¼ ë³€í™˜í•œ í›„ APIë¡œ ì „ì†¡í•©ë‹ˆë‹¤.
Dynamic Task Mappingì„ ì‚¬ìš©í•˜ì—¬ ê° ì¥ì†Œë¥¼ ë…ë¦½ì ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
"""
from airflow import DAG
from airflow.decorators import task
from datetime import datetime, timedelta
from stroll.crawl.crawl import crawl
from stroll.crawl.process_place import process_single_place

default_args = {
    "owner": "airflow",
    "depends_on_past": False,
    "start_date": datetime(2025, 10, 6),
    "email": ["airflow@airflow.com"],
    "email_on_failure": False,
    "email_on_retry": False,
    "retries": 2,  # ê°œë³„ ì¥ì†Œ ì²˜ë¦¬ ì‹¤íŒ¨ ì‹œ 2ë²ˆ ì¬ì‹œë„
    "retry_delay": timedelta(minutes=1),
}

with DAG(
    dag_id="crawl_and_rag",
    default_args=default_args,
    schedule_interval=timedelta(days=1),
    catchup=False,
    tags=["stroll", "crawl", "naver", "dynamic-mapping"],
    description="ë„¤ì´ë²„ ì§€ë„ í¬ë¡¤ë§ ë° ë™ì  ì¥ì†Œ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ (Dynamic Task Mapping)",
    max_active_tasks=10,  # ë™ì‹œ ì²˜ë¦¬ ìµœëŒ€ 10ê°œ ì¥ì†Œ
) as dag:
    
    @task(task_id="crawl_places")
    def crawl_task():
        """
        ë„¤ì´ë²„ ì§€ë„ì—ì„œ ëª¨ë“  ì¥ì†Œ ë°ì´í„°ë¥¼ í¬ë¡¤ë§í•©ë‹ˆë‹¤.
        Returns: ì¥ì†Œ ê°ì²´ ë¦¬ìŠ¤íŠ¸ [{"placeName": ..., "category": ..., "address": ...}, ...]
        """
        return crawl(None)
    
    @task(task_id="process_place")
    def process_place_task(place_obj: dict):
        """
        ë‹¨ì¼ ì¥ì†Œë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤: ì£¼ì†Œ ë³€í™˜ + API ì „ì†¡
        ê° ì¥ì†Œê°€ ë…ë¦½ì ì¸ Taskë¡œ ì‹¤í–‰ë˜ë©°, ì‹¤íŒ¨ ì‹œ ê°œë³„ì ìœ¼ë¡œ ì¬ì‹œë„ë©ë‹ˆë‹¤.
        
        Args:
            place_obj: í¬ë¡¤ë§ëœ ì¥ì†Œ ë°ì´í„°
        Returns:
            ì²˜ë¦¬ ê²°ê³¼ {"status": "success"/"failed", "placeName": ..., ...}
        """
        return process_single_place(place_obj)
    
    @task(task_id="summarize_results")
    def summarize_task(results: list):
        """
        ëª¨ë“  ì¥ì†Œ ì²˜ë¦¬ ê²°ê³¼ë¥¼ ìš”ì•½í•©ë‹ˆë‹¤.
        
        Args:
            results: ê° ì¥ì†Œ ì²˜ë¦¬ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸
        """
        success_count = sum(1 for r in results if r.get("status") == "success")
        fail_count = sum(1 for r in results if r.get("status") == "failed")
        
        print("\n" + "="*50)
        print("ğŸ“Š ìµœì¢… ì²˜ë¦¬ ê²°ê³¼ ìš”ì•½")
        print("="*50)
        print(f"âœ“ ì„±ê³µ: {success_count}ê°œ")
        print(f"âœ— ì‹¤íŒ¨: {fail_count}ê°œ")
        print(f"ğŸ“ ì´ ì²˜ë¦¬: {len(results)}ê°œ")
        
        if fail_count > 0:
            print("\nì‹¤íŒ¨í•œ ì¥ì†Œ ëª©ë¡:")
            for r in results:
                if r.get("status") == "failed":
                    print(f"  - {r.get('placeName', 'Unknown')}: {r.get('error', 'Unknown error')}")
        
        return {
            "total": len(results),
            "success": success_count,
            "failed": fail_count
        }
    
    # Task ì˜ì¡´ì„± ì •ì˜ with Dynamic Task Mapping
    # 1. ëª¨ë“  ì¥ì†Œ í¬ë¡¤ë§
    places = crawl_task()
    
    # 2. ê° ì¥ì†Œë¥¼ ë…ë¦½ì ì¸ Taskë¡œ ì²˜ë¦¬ (Dynamic Mapping)
    # expand()ë¥¼ ì‚¬ìš©í•˜ì—¬ ê° place_objë§ˆë‹¤ ë³„ë„ì˜ Task ìƒì„±
    process_results = process_place_task.expand(place_obj=places)
    
    # 3. ëª¨ë“  ì²˜ë¦¬ ê²°ê³¼ ìš”ì•½
    summarize_task(process_results)
